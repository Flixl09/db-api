<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="version" content="20210917-1">
    <title></title>
</head>

<body>
       <noscript>Please Enable JavaScript</noscript>

<div class="container"></div>

<script>

var origin = 'http://127.0.0.1:8980';
//let base64 = 'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX=';

async function handleResponse(response) {
    if (!response.ok) {
        const json = await response.json();
        let clear = '<button onclick="localStorage.clear();location.reload();">clear</button>';
        throw new Error(JSON.stringify(json) +' '+ clear);
    }
    return response;
}

function Login() {
   var base64 = window.prompt("base64 credentials: ");
   localStorage.setItem('base64', base64);
   history.pushState({view: 'login'}, "login", "?view=login");
}

function Logout() {
    localStorage.clear();
    document.write('logout');
    history.pushState({view: 'logout'}, "logout", "?logout=true");
}



async function renderDBs(base64) {

    let url = origin + '/api';

    let response = await fetch(url, {headers:{Authorization: 'Basic ' + base64}})
        .then(handleResponse)
        .catch(err => document.write('Request Failed ', err));

    let items = await response.json();

    let html = '';
    items.forEach(item => {
        let htmlSegment = `<div> <button onclick="renderBucketFiles('${item}')">${item}</button> </div>`;
        //let htmlSegment = `<div> ${item} </div>`;
        html += htmlSegment;
    });    

    let container = document.querySelector('.container');
    container.innerHTML = html;

    history.pushState({view: 'db'}, "db", "?view=db");
}


function landing() {

    if ( ! localStorage.getItem('base64') ) {
        Login();
    }

    const base64 = localStorage.getItem('base64');

    renderDBs(base64);


}

console.log('start');

var params = new URLSearchParams(window.location.search);

if (!params.toString()) {
    landing();
}

if (params.has('logout')) {
   Logout();
}

if (params.has('view')) {
    view = params.get('view');
    landing();
}

console.log('done');

</script>

</body>
</html>
