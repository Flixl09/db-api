<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="version" content="20210924-1">
    <title></title>
</head>

<body>
       <noscript>Please Enable JavaScript</noscript>

<div class="container"></div>

<script>

var start = performance.now();

async function handleResponse(response) {
    if (!response.ok) {
        let json = await response.json();
        throw new Error(JSON.stringify(json));
    }
    return response;
}

function Login() {
   let origin = window.prompt("url: ", 'http://127.0.0.1:8980');
   let user = window.prompt("username: ");
   let pass = window.prompt("password: ");
   let base64 = btoa(user + ':' + pass);

   localStorage.setItem('base64', base64);
   localStorage.setItem('origin', origin);

   history.pushState({view: 'login'}, "login", "?view=login");
}

function Logout() {
    localStorage.clear();

    let container = document.querySelector('.container');
    let html = '<a href="?">Login</a>';    
    container.innerHTML = html;

    history.pushState({view: 'logout'}, "logout", "?logout=true");
}

async function showDBs() {

    let origin = localStorage.getItem('origin');
    let base64 = localStorage.getItem('base64');

    let url = origin + '/api';

    let response = await fetch(url, {headers:{Authorization: 'Basic ' + base64}})
        .then(handleResponse)
        .catch(err => document.write('Request Failed ', err + '<div><button onclick="localStorage.clear();location.reload();">clear</button></div>'));

    let items = await response.json();

    let html = '';
    items.forEach(item => {
        //let htmlSegment = `<div> <button onclick="showTables('${item}')">${item}</button> </div>`;
        let htmlSegment = `<div> <a href="?db=${item}">${item}</a></div>`;
        html += htmlSegment;
    });    

    html += '<hr><div><button onclick="localStorage.clear();location.reload();">Logout</button></div>';

    let container = document.querySelector('.container');
    container.innerHTML = html;

    document.title = 'show databases';

    history.pushState({view: 'dbs'}, "dbs", "?view=dbs");
}

async function showTables(db) {

    let origin = localStorage.getItem('origin');
    let base64 = localStorage.getItem('base64');

    let url = origin + '/api/' + db ;


    let response = await fetch(url, {headers:{Authorization: 'Basic ' + base64}})
        .then(handleResponse)
        .catch(err => document.write('Request Failed ', err));

    let items = await response.json();

    let html = '';
    items.forEach(item => {
        let htmlSegment = `<div> <a href="?db=${db}&table=${item}">${item}</a> `;
        htmlSegment    += `      <a href="?form=post&db=${db}&table=${item}"><button>Insert</button></a> </div>`;
        html += htmlSegment;
    });

    let container = document.querySelector('.container');
    container.innerHTML = html;

    document.title = db;

    history.pushState({db: db}, db, "?db=" + db);
}


async function listItems(db, table) {

    let origin = localStorage.getItem('origin');
    let base64 = localStorage.getItem('base64');

    //let url = origin + '/api/' + db + '/' + table + "?limit=100" ;
    let url = origin + '/api/' + db + '/' + table + "?query=true" ;


    let response = await fetch(url, {headers:{Authorization: 'Basic ' + base64}})
        .then(handleResponse)
        .catch(err => document.write('Request Failed ', err));

    let items = await response.json();

    let html = '';
    items.forEach(item => {

        let strArr = item.toString().split(",");
        //let _id = strArr[0];
        let id = strArr[0];

        //let htmlSegment = `<div> <button onclick="showRow('${db}', '${table}', '${_id}')">${item}</button> </div>`;
        let htmlSegment = `<div> <a href="?db=${db}&table=${table}&id=${id}">${item}</a> `;
        htmlSegment    += `<button onclick="putForm('${db}', '${table}', '${id}')">Replace</button>`;
        htmlSegment    += `<button onclick="deleteItem('${db}', '${table}', '${id}')">Delete</button> </div>`;
        html += htmlSegment;
    });

    let container = document.querySelector('.container');
    container.innerHTML = html;

    document.title = db +' '+ table;

    history.pushState({db_table: db + table}, db + table, "?db=" + db + "&table=" + table);
}

async function deleteItem(db, table, id) {

    let origin = localStorage.getItem('origin');
    let base64 = localStorage.getItem('base64');

    //let url = origin + '/api/' + db + '/' + table + '/' + id + '?column=' + first_field ;
    let url = origin + '/api/' + db + '/' + table + '/' + id  ;
    let delete_response = await fetch(url, {method:'DELETE',headers:{Authorization: 'Basic ' + base64}})
        .then(handleResponse)
        .catch(err => document.write('Request Failed ', err));

    let response = await delete_response.json();

    html = JSON.stringify(response);

    html += '<hr><a href="?db='+db+'&table='+table+'">db.table</a>';

    let container = document.querySelector('.container');
    container.innerHTML = html;

    document.title = db +' '+ table +' '+ id + 'deleted';

    history.pushState({db_table_id_deleted: db + table + id +'deleted'}, db + table + id, "?db=" + db + "&table=" + table + "&id=" + id + "&deleted=True");
}

async function showRow(db, table, id) {

    let origin = localStorage.getItem('origin');
    let base64 = localStorage.getItem('base64');

    let fields_url = origin + '/api/' + db + '/' + table ;
    let fields_response = await fetch(fields_url, {headers:{Authorization: 'Basic ' + base64}})
        .then(handleResponse)
        .catch(err => document.write('Request Failed ', err));
    let fields = await fields_response.json();


    const columns = [];
    fields.forEach(item => {
        let strArr = item.toString().split(",");
        let field_name = strArr[0];
        columns.push(field_name);
    });

    let first_field = columns[0];

    //let items_url = origin + '/api/' + db + '/' + table + '/' + id + '?column=Host' ;
    let items_url = origin + '/api/' + db + '/' + table + '/' + id + '?column=' + first_field ;
    let items_response = await fetch(items_url, {headers:{Authorization: 'Basic ' + base64}})
        .then(handleResponse)
        .catch(err => document.write('Request Failed ', err));
    let items = await items_response.json();

    let html = '';
    let count = 0;

    items.forEach(item => {

        let column = columns[count];

        //let htmlSegment = `<div>${columns[count]}</div><div><input value="${item}" > </input>  <button onclick="patchRecord('${db}', '${table}', '${id}', '${columns[count]}')">edit</button> </div>`;
        let htmlSegment = `<div>${columns[count]}</div><div><input value="${item}" > </input>  <a href="?db=${db}&table=${table}&id=${id}&column=${column}">edit</a> </div>`;

        html += htmlSegment;
        count++;
    });


    let container = document.querySelector('.container');
    container.innerHTML = html;

    document.title = db +' '+ table +' '+ id;

    history.pushState({db_table_id: db + table + id}, db + table + id, "?db=" + db + "&table=" + table + "&id=" + id);
}

async function submitpatchForm(event){

    let origin = localStorage.getItem('origin');
    let base64 = localStorage.getItem('base64');

    event.preventDefault();

    let column = document.getElementById('patch').name;

    let value = event.target[column].value;

    let strTxt = '{ "' + column + '" : "' + value + '" }';

    const data = JSON.parse(strTxt);

    let url = origin + '/api/' + db + '/' + table + '/' + id ;

    let patch = await fetch(url, {
                               method: 'PATCH',
                               mode: 'cors',
                               headers: {
                                   'Content-Type': 'application/json',
                                   'Accept': 'application/json',
                                   'Authorization': 'Basic ' + base64
                               },
                               body: JSON.stringify(data)
                               })
                          .then(handleResponse)
                          .catch(err => document.write('Request Failed ', err));

    let response = await patch.json();

    html = JSON.stringify(response);

    html += '<hr><a href="?db='+db+'&table='+table+'&id='+id+'">'+id+'</a>';

    let container = document.querySelector('.container');
    container.innerHTML = html;

    document.title = db +' '+ table +' '+ id + ' ' + column;

    success = 'True';
    history.pushState({db_table_id_column: db + table + id + column}, db + table + id + column, "?db=" + db + "&table=" + table + "&id=" + id + "&column=" + column + "&patch=" + success);
}

async function patchRecord(db, table, id, column) {

    console.log('patch'); 
    console.log(db); 
    console.log(table); 
    console.log(id); 
    console.log(column);

    let html = '<div>' + column + '</div>';

    html += '<form onsubmit="submitpatchForm(event)">';
    html += '<input type="text" name="' + column + '" id="patch" value="value">';
    html += '<input type="submit" value="patch"></form>';

    let container = document.querySelector('.container');
    container.innerHTML = html;

    document.title = db +' '+ table +' '+ id +' ' + column;

    history.pushState({db_table_id: db + table + id}, db + table + id, "?db=" + db + "&table=" + table + "&id=" + id + "&column=" + column);
}

async function postForm(db, table) {

    /*
      get table fields
      create form
      post data
    */

    let origin = localStorage.getItem('origin');
    let base64 = localStorage.getItem('base64');

    let fields_url = origin + '/api/' + db + '/' + table ;
    let fields_response = await fetch(fields_url, {headers:{Authorization: 'Basic ' + base64}})
        .then(handleResponse)
        .catch(err => document.write('Request Failed ', err));
    let fields = await fields_response.json();

    const columns = [];

    fields.forEach(item => {
        let strArr = item.toString().split(",");
        let field_name = strArr[0];
        columns.push(field_name);
    });

    let first_field = columns[0];

    let html = '<div>'+db+'.'+table+'</div>';
    let htmlSegment = `<div><form method="POST" action="${fields_url}">`;
    columns.forEach(function (item, index) {
        htmlSegment += `<div>`;
        htmlSegment += `<input type="text" name="${item}" id="${item}" value="${item}" disabled >`;
        htmlSegment += `<button type="button" onclick="toggleEnable('${item}')"> Enable/Disable </button>`;
        htmlSegment += `</div>`;
    });
    htmlSegment += `<div>credentials</div>`;
    htmlSegment += `<div><input type="password" name="credentials" id="credentials" value="${base64}"></div>`;
    htmlSegment += `<div><input type="submit" value="post"></div>`;
    htmlSegment += `</form></div>`;

    html += htmlSegment

    let container = document.querySelector('.container');
    container.innerHTML = html;

    document.title = 'form post ' + db +' '+ table;

    history.pushState({form_post_db_table: db + table}, db + table, "?db=" + db + "&table=" + table + "&form=post" );

}

function toggleEnable(id) {
    var textbox = document.getElementById(id);

    if (textbox.disabled) {
        // If disabled, do this
        document.getElementById(id).disabled = false;
    } else {
        // Enter code here
        document.getElementById(id).disabled = true;
    }
}


async function putForm(db, table, id) {

    console.log('replace');
    console.log('db is... ' + db);
    console.log('table is... ' + table);
    console.log('id is... ' + id);

    /*
      get table fields
      get item (existing record data)
      create form
      put data
    */

    let origin = localStorage.getItem('origin');
    let base64 = localStorage.getItem('base64');

    let fields_url = origin + '/api/' + db + '/' + table ;
    let fields_response = await fetch(fields_url, {headers:{Authorization: 'Basic ' + base64}})
        .then(handleResponse)
        .catch(err => document.write('Request Failed ', err));

    let fields = await fields_response.json();

    const columns = [];

    fields.forEach(item => {
        let strArr = item.toString().split(",");
        let field_name = strArr[0];
        columns.push(field_name);
    });

    let first_field = columns[0];

    console.log('first_field ' + first_field);

    let items_url = origin + '/api/' + db + '/' + table + '/' + id + '?column=' + first_field ;

    let items_response = await fetch(items_url, {headers:{Authorization: 'Basic ' + base64}})
        .then(handleResponse)
        .catch(err => document.write('Request Failed ', err));

    let items = await items_response.json();

    let dict = {};

    count=0;
    items.forEach(item => {

        let column = columns[count];

        dict[column] = item;

        count++;
    });

    let html = '<div>put '+db+'.'+table+'</div>';
    let htmlSegment = `<div><form >`;

    for(var key in dict) {
        console.log(key + " : " + dict[key]);

        htmlSegment += `<div>`;
        htmlSegment += `<input type="text" name="${key}" id="${key}" value="${dict[key]}" disabled >`;
        htmlSegment += `<button type="button" onclick="toggleEnable('${key}')"> Toggle </button>`;
        htmlSegment += `</div>`;

    }


    //columns.forEach(function (item, index) {
    //    htmlSegment += `<div>`;
    //    htmlSegment += `<input type="text" name="${item}" id="${item}" value="${item}" disabled >`;
    //    htmlSegment += `<button type="button" onclick="toggleEnable('${item}')"> Toggle </button>`;
    //    htmlSegment += `</div>`;
    //});
    htmlSegment += `<div>credentials</div>`;
    htmlSegment += `<div><input type="password" name="credentials" id="credentials" value="${base64}"></div>`;
    htmlSegment += `<div><input type="submit" value="put"></div>`;
    htmlSegment += `</form></div>`;

    html += htmlSegment

    let container = document.querySelector('.container');
    container.innerHTML = html;

    document.title = 'form put ' + db +' '+ table;

    history.pushState({form_put_db_table: db + table}, db + table, "?db=" + db + "&table=" + table + "&form=put" );

}


function landing() {
    if ( ! localStorage.getItem('base64') ) {
        Login();
    }
    showDBs();
}

/* main */

var params = new URLSearchParams(window.location.search);

window.addEventListener('popstate', function (event) {
    //console.log('event popstate activated');
    location.reload();
});

if (!params.toString()) {
    landing();
}

if (params.has('logout')) {
   Logout();
}

if (params.has('view')) {
    view = params.get('view');
    landing();
}

if (params.has('form')) {
    db = params.get('db');
    table = params.get('table');
    id    = params.get('id');
    form = params.get('form');

    if (form === 'post') {
        postForm(db, table);
    } else if (form === 'put') {
        putForm(db, table);
    }

} else if (params.has('db') && params.has('table') && params.has('id') && params.has('column') ) {
    db    = params.get('db');
    table = params.get('table');
    id    = params.get('id');
    column = params.get('column');
    patchRecord(db, table, id, column);
} else if (params.has('db') && params.has('table') && params.has('id')) {
    db    = params.get('db');
    table = params.get('table');
    id    = params.get('id');
    showRow(db, table, id);
} else if (params.has('db') && params.has('table')) {
    db    = params.get('db');
    table = params.get('table');
    listItems(db, table);
} else if (params.has('db')) {
    db    = params.get('db');
    showTables(db);
} 

var done = performance.now() - start;
console.log('done ' + done);

</script>

</body>
</html>
